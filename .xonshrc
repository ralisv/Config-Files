import sys
import os

from math import factorial, pi, e, gcd, log
from wpm.commandline import main as wpm

sys.path.append(os.path.expanduser("~/.local/lib/python3.10/site-packages"))
sys.path.append(os.path.expanduser("~/Config-Files"))

$LS_COLORS = open(os.path.expanduser("~/Config-Files/ls-colors.txt")).read()

from utils import *

$PATH.append(os.path.expanduser("~/.local/bin"))


$AUTO_CD = True
$CASE_SENSITIVE_COMPLETIONS = False
$COMPLETION_IN_THREAD = True
$COMPLETION_MODE = "default"
$COMPLETION_QUERY_LIMIT = 10
$COMPLETIONS_CONFIRM = False
$COMPLETIONS_MENU_ROWS = 2
$DYNAMIC_CWD_WIDTH = "50%"
$DYNAMIC_CWD_ELISION_CHAR = "..."
$FOREIGN_ALIASES_SUPPRESS_SKIP_MESSAGE = 1
$INDENT = "   "
$MULTILINE_PROMPT = " "
$SUBSEQUENCE_PATH_COMPLETION = True
$SUGGEST_COMMANDS = True
$SUGGEST_MAX_NUM = 20
$TITLE = "My lovely terminal"
$UPDATE_COMPLETIONS_ON_KEYPRESS = False
$XONSH_AUTOPAIR = True
$XONSH_COLOR_STYLE = "paraiso-dark"
$XONSH_HISTORY_MATCH_ANYWHERE = True


# Important aliases
my_aliases = {
    "d": "cd",
    "c": "cd",
    "ls": "ls --color=auto",
    "drive": "mountpoint -q ~/Drive || setsid rclone mount Google-Drive:Drive ~/Drive",
    "micro": "code",
    "okular": lambda args: start_in_new_session("/usr/bin/okular", args),
    "vlc": lambda args: start_in_new_session("/snap/bin/vlc", args),
    "rm": lambda args: remove(args),
    "s": lambda args: super_ls(args),
    "grep": "grep --color=auto",
    "sl": "sl -e",
    "du": "du -h",
    "python": "python3.10",
    "pip": "python -m pip",
    "trans": "~/Executables/trans -j -d -t czech",
    "cat":"batcat --pager=never",
    "maisa": f"sshfs 'xralis@aisa.fi.muni.cz:/home/xralis' {os.path.expanduser('~')}/aisa",
    "aisa": "ssh 'xralis@aisa.fi.muni.cz'",
    "valgrind": "colour-valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all --track-origins=yes --show-reachable=yes --track-fds=yes -s",
    "stackusage": "colour-valgrind --tool=drd --show-stack-usage=yes",
    "R": "R --no-save -q",
    "battery-info": "upower -i /org/freedesktop/UPower/devices/battery_BAT0",
    "xaisa": "xxh 'xralis@aisa.fi.muni.cz'",
}

aliases.update(my_aliases)


# Style the terminal

from xonsh.tools import register_custom_style

mystyle = {
    "Literal.String.Single": "#55ff55",
    "Literal.String.Double": "#55ff55",
    "Token.Operator": "#fffd00",
    "Token.PTK.CompletionMenu": "#000000",
    "Token.Literal.Number.Integer": "#44ffff",
}

register_custom_style("mystyle", mystyle, base="paraiso-dark")
$XONSH_COLOR_STYLE="mystyle"

def customize_autocompleter():
    import prompt_toolkit.styles.defaults as defstyle
    defstyle.PROMPT_TOOLKIT_STYLE.append(('bottom-toolbar','noreverse'))
    defstyle.PROMPT_TOOLKIT_STYLE.append(('completion-menu','bg:#880088 #000000'))

customize_autocompleter()


# Prompt

RED = "{#ff9999}"
PINK = "{#ff22bb}"
BLUE = "{#00b0ff}"
WHITE = "{#ffffff}"

def enclose_in_brackets(text: str) -> str:
    return f"{PINK}[{text}{PINK}] "

def git_info() -> str:
    if not os.path.isdir(".git"):
        return ""

    branch = subprocess.check_output(["git", "branch", "--show-current"]).decode("utf-8").strip()
    if branch == "master":
        branch = "main"
    return enclose_in_brackets(f"{BLUE}{branch}")

HOME_DIRECTORY = os.path.expanduser("~")

def path_info() -> str:
    return enclose_in_brackets(f"{BLUE}{os.getcwd().replace(HOME_DIRECTORY, '~')}")


$PROMPT_FIELDS["git-info"] = git_info
$PROMPT_FIELDS["path-info"] = path_info

USER_FIELD = "{user}"
PATH_FIELD = "{path-info}"
GIT_FIELD = "{git-info}"

$PROMPT = f"{PINK}{USER_FIELD}.{PATH_FIELD}{GIT_FIELD}Î» " 


# Colored man pages

$LESS_TERMCAP_mb="\x1b[1;32m"
$LESS_TERMCAP_md="\x1b[38;2;255;180;50m"
$LESS_TERMCAP_me="\x1b[0m"
$LESS_TERMCAP_se="\x1b[0m"
$LESS_TERMCAP_so="\x1b[38;2;255;255;50m"
$LESS_TERMCAP_ue="\x1b[0m"
$LESS_TERMCAP_us="\x1b[38;2;255;100;50m"


# Ask about dumping trash

ask_whether_to_dump()
